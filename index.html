<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Escape The Loop</title>
  <style>
    body { background:#111; margin:0; display:flex; justify-content:center; align-items:center; height:100vh; }
    canvas { background:#222; display:block; border:3px solid #555; }
  </style>
</head>
<body>
<canvas id="gameCanvas" width="640" height="640"></canvas>
<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

const tileSize = 40;
let keysPressed = {};
let gameStarted = false;
let gameOver = false;
let victory = false;
let currentLevel = 0;
let keysCollected = 0;
let score = 0;

let levelMessage = "";
let messageTimer = 0;

let player = {x:1,y:1};

// --- LEVELS ---
let levels = [
  // Level 1 (Tutorial)
  {
    maze:[
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,1,1,1,1,1,1,1,1,0,1,1,1,0,1],
      [1,0,1,0,0,0,0,0,0,1,0,0,0,1,0,1],
      [1,0,1,0,1,1,1,1,0,1,1,1,0,1,0,1],
      [1,0,1,0,1,0,0,1,0,0,0,1,0,1,0,1],
      [1,0,0,0,1,0,1,1,1,1,0,1,0,0,0,1],
      [1,1,1,0,1,0,0,0,0,1,0,1,1,1,0,1],
      [1,0,0,0,1,1,1,1,0,1,0,0,0,1,0,1],
      [1,0,1,0,0,0,0,1,0,1,1,1,0,1,0,1],
      [1,0,1,1,1,1,0,1,0,0,0,1,0,1,0,1],
      [1,0,0,0,0,1,0,1,1,1,0,1,0,1,0,1],
      [1,1,1,1,0,1,0,0,0,1,0,1,0,1,0,1],
      [1,0,0,1,0,1,1,1,0,1,0,1,0,1,0,1],
      [1,0,0,0,0,0,0,1,0,0,0,0,0,0,9,1],
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ],
    keys:[{x:3,y:3}],
    diamonds:[{x:5,y:5}],
    enemies:[{x:10,y:2,floatX:10,floatY:2,speed:0.02}],
    portal:{x:14,y:14}
  },
  // Level 2
  {
    maze:[
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
      [1,0,0,0,0,1,0,0,0,0,0,0,1,0,0,1],
      [1,0,1,1,0,1,0,1,1,1,1,0,1,0,1,1],
      [1,0,0,1,0,0,0,1,0,0,1,0,0,0,0,1],
      [1,1,0,1,1,1,0,1,0,1,1,1,1,1,0,1],
      [1,0,0,0,0,0,0,1,0,0,0,0,0,1,0,1],
      [1,0,1,1,1,1,0,1,1,1,1,1,0,1,0,1],
      [1,0,0,0,0,1,0,0,0,0,0,1,0,1,0,1],
      [1,1,1,1,0,1,1,1,1,1,0,1,0,1,0,1],
      [1,0,0,1,0,0,0,0,0,1,0,1,0,1,0,1],
      [1,0,1,1,1,1,1,1,0,1,0,1,0,1,0,1],
      [1,0,0,0,0,0,0,1,0,1,0,0,0,0,0,1],
      [1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1],
      [1,0,0,0,0,0,0,1,0,0,0,0,0,1,0,1],
      [1,0,1,1,1,1,0,0,0,1,1,1,0,0,9,1],
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ],
    keys:[{x:2,y:1},{x:12,y:13}],
    diamonds:[{x:7,y:7}],
    enemies:[{x:13,y:2,floatX:13,floatY:2,speed:0.025}],
    portal:{x:14,y:14}
  },
  // Level 3
  {
    maze:[
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
      [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1],
      [1,0,1,1,1,1,1,1,0,1,0,1,1,1,0,1],
      [1,0,1,0,0,0,0,1,0,1,0,0,0,1,0,1],
      [1,0,1,0,1,1,0,1,0,1,1,1,0,1,0,1],
      [1,0,1,0,1,0,0,1,0,0,0,1,0,1,0,1],
      [1,0,0,0,1,0,1,1,1,1,0,1,0,0,0,1],
      [1,1,1,0,1,0,0,0,0,1,0,1,1,1,0,1],
      [1,0,0,0,1,1,1,1,0,1,0,0,0,1,0,1],
      [1,0,1,0,0,0,0,1,0,1,1,1,0,1,0,1],
      [1,0,1,1,1,1,0,1,0,0,0,1,0,1,0,1],
      [1,0,0,0,0,1,0,1,1,1,0,1,0,1,0,1],
      [1,1,1,1,0,1,0,0,0,1,0,1,0,1,0,1],
      [1,0,0,1,0,1,1,1,0,1,0,1,0,1,0,1],
      [1,0,0,0,0,0,0,1,0,0,0,0,0,0,9,1],
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ],
    keys:[{x:2,y:1},{x:13,y:13},{x:6,y:10}],
    diamonds:[{x:5,y:5},{x:10,y:10}],
    enemies:[
      {x:10,y:2,floatX:10,floatY:2,speed:0.03},
      {x:3,y:8,floatX:3,floatY:8,speed:0.028}
    ],
    portal:{x:14,y:14}
  },
  // Level 4
  {
    maze:[
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
      [1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],
      [1,0,1,1,1,1,0,1,0,1,1,1,1,1,0,1],
      [1,0,1,0,0,0,0,1,0,0,0,0,0,1,0,1],
      [1,0,1,0,1,1,1,1,1,1,1,1,0,1,0,1],
      [1,0,0,0,1,0,0,0,0,0,0,1,0,1,0,1],
      [1,1,1,0,1,0,1,1,1,1,0,1,0,1,0,1],
      [1,0,0,0,0,0,0,1,0,1,0,1,0,0,0,1],
      [1,0,1,1,1,1,0,1,0,1,0,1,1,1,0,1],
      [1,0,0,0,0,0,0,1,0,0,0,0,0,1,0,1],
      [1,1,1,1,1,1,0,1,1,1,1,1,0,1,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1],
      [1,0,1,1,1,1,1,1,1,1,0,1,0,1,0,1],
      [1,0,0,0,0,0,0,0,0,1,0,0,0,0,9,1],
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ],
    keys:[{x:2,y:1},{x:10,y:9},{x:13,y:13},{x:7,y:4}],
    diamonds:[{x:5,y:2},{x:11,y:11}],
    enemies:[
      {x:12,y:2,floatX:12,floatY:2,speed:0.035},
      {x:4,y:10,floatX:4,floatY:10,speed:0.03},
      {x:8,y:6,floatX:8,floatY:6,speed:0.032}
    ],
    portal:{x:14,y:13}
  },
  // Level 5 (Final)
  {
    maze:[
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,1,1,1,1,1,1,1,1,1,1,1,1,0,1],
      [1,0,1,0,0,0,0,0,0,0,0,0,0,1,0,1],
      [1,0,1,0,1,1,1,1,1,1,1,1,0,1,0,1],
      [1,0,1,0,1,0,0,0,0,0,0,1,0,1,0,1],
      [1,0,0,0,1,0,1,1,1,1,0,1,0,0,0,1],
      [1,1,1,0,1,0,0,0,0,1,0,1,1,1,0,1],
      [1,0,0,0,1,1,1,1,0,1,0,0,0,1,0,1],
      [1,0,1,0,0,0,0,1,0,1,1,1,0,1,0,1],
      [1,0,1,1,1,1,0,1,0,0,0,1,0,1,0,1],
      [1,0,0,0,0,1,0,1,1,1,0,1,0,1,0,1],
      [1,1,1,1,0,1,0,0,0,1,0,1,0,1,0,1],
      [1,0,0,1,0,1,1,1,0,1,0,1,0,1,9,1],
      [1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ],
    keys:[{x:2,y:1},{x:6,y:6},{x:10,y:12},{x:12,y:8},{x:13,y:13}],
    diamonds:[{x:7,y:2},{x:4,y:10},{x:11,y:11}],
    enemies:[
      {x:13,y:2,floatX:13,floatY:2,speed:0.04},
      {x:3,y:10,floatX:3,floatY:10,speed:0.038},
      {x:7,y:6,floatX:7,floatY:6,speed:0.04},
      {x:9,y:8,floatX:9,floatY:8,speed:0.042}
    ],
    portal:{x:14,y:13}
  }
];

// --- Reset Level ---
function resetLevel(){
  let lvl = levels[currentLevel];
  gameOver=false;
  victory=false;
  keysCollected=0;
  player.x = 1; player.y = 1;
  lvl.enemies.forEach(e=>{ e.floatX=e.x; e.floatY=e.y; });
  lvl.enemies.forEach(e=>{
    if(Math.floor(e.floatX)===player.x && Math.floor(e.floatY)===player.y){ player.y+=1; }
  });
  levelMessage=`Level ${currentLevel+1}: Collect all keys and reach the portal!`;
  messageTimer=180;
}

// --- Input ---
window.addEventListener("keydown",e=>{
  keysPressed[e.key]=true;
  if(e.key==="Enter") gameStarted=true;
  if(e.key==="r"||e.key==="R"){ resetLevel(); }
});
window.addEventListener("keyup",e=>{ keysPressed[e.key]=false; });

// --- Movement ---
function movePlayer(){
  if(gameOver||!gameStarted||messageTimer>0) return;
  let dx=0,dy=0;
  if(keysPressed["ArrowUp"]||keysPressed["w"]) dy=-1;
  if(keysPressed["ArrowDown"]||keysPressed["s"]) dy=1;
  if(keysPressed["ArrowLeft"]||keysPressed["a"]) dx=-1;
  if(keysPressed["ArrowRight"]||keysPressed["d"]) dx=1;
  if(dx!==0||dy!==0){
    let maze=levels[currentLevel].maze;
    let nx=player.x+dx, ny=player.y+dy;
    if(maze[ny][nx]===0||maze[ny][nx]===9){ player.x=nx; player.y=ny; }
    levels[currentLevel].keys=levels[currentLevel].keys.filter(k=>{
      if(k.x===player.x && k.y===player.y){ keysCollected++; score+=100; return false; }
      return true;
    });
    levels[currentLevel].diamonds=levels[currentLevel].diamonds.filter(d=>{
      if(d.x===player.x && d.y===player.y){ score+=500; return false; }
      return true;
    });
    if(player.x===levels[currentLevel].portal.x && player.y===levels[currentLevel].portal.y){
      if(levels[currentLevel].keys.length===0){
        currentLevel++;
        if(currentLevel>=levels.length){ victory=true; gameStarted=false; }
        else resetLevel();
      }
    }
  }
}
function moveEnemiesSmooth(){
  let maze=levels[currentLevel].maze;
  levels[currentLevel].enemies.forEach(e=>{
